<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="create_form">
    <style>
        .help {
            color: var(--wa-color-muted, #6b7280);
            font-size: 12px
        }

        .empty-row td {
            color: #6b7280;
            text-align: center
        }

        .sticky-head thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: var(--wa-color-surface, #fff)
        }

        .zebra tbody tr:nth-child(odd) {
            background: #fafafa
        }

        .form-title {
            font-weight: 700;
            font-size: 18px;
            line-height: 1.3;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 2px 0 10px 0
        }

        .form-title .bar {
            width: 6px;
            height: 18px;
            border-radius: 4px;
            background: #111827;
            opacity: .9
        }

        .section-title {
            font-weight: 600;
            font-size: 13px;
            color: #111827;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 10px;
            margin: 2px 0 8px 0
        }

        #create-product-card {
            margin-top: 16px
        }

        .sticky-actions {
            position: static;
            bottom: 0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 1) 24px);
            padding-top: 8px;
            border-top: 1px solid #e5e7eb
        }

        .variants-scroll {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 6px
        }

        .variants-scroll .wa-table {
            min-width: 1100px
        }

        .variants-scroll td > wa-input {
            min-width: 120px;
            display: block
        }

        .variants-scroll td:nth-child(1) > wa-input,
        .variants-scroll td:nth-child(2) > wa-input,
        .variants-scroll td:nth-child(3) > wa-input {
            min-width: 100px
        }

        .variants-scroll td:nth-child(9) > wa-input {
            min-width: 200px
        }

        .variants-scroll th:nth-child(10),
        .variants-scroll td:nth-child(10) {
            width: 64px;
            white-space: nowrap
        }

        .variants-scroll td:nth-child(8) {
            text-align: center;
            min-width: 90px
        }
    </style>

    <wa-card id="create-product-card" class="wa-stack" style="padding:14px" hx-on="htmx:load: resetVariantTable()">
        <div class="form-title">
            <span class="bar"></span>
            <span>Add product</span>
        </div>

        <form id="create-product-form"
              hx-post="/addProducts"
              hx-target="#create-product-card"
              hx-swap="outerHTML"
              class="wa-stack">

            <!-- Basic info -->
            <div class="section-title">Basic info</div>
            <div class="wa-grid wa-grid-cols-2 wa-gap-3">
                <wa-input name="productId" type="number" required label="Product ID (unique)"></wa-input>
                <wa-input name="title" required label="Title"></wa-input>
                <wa-input name="vendor" label="Vendor"></wa-input>
                <wa-input name="productType" label="Product Type"></wa-input>

                <wa-input class="wa-col-span-2"
                          name="tagsText"
                          label="Tags"
                          placeholder="e.g. gym, everyday-collection">
                    <div slot="helper" class="help">Comma separated. Example: <code>gym, everyday-collection</code>
                    </div>
                </wa-input>
            </div>

            <!-- Options -->
            <div class="section-title">Options (up to 3)</div>
            <div class="wa-grid wa-grid-cols-3 wa-gap-3">
                <wa-input name="optionNames[0]" value="Color" label="Option 1 Name"
                          oninput="syncOptionHeader(1,this.value)">
                    <div slot="helper" class="help">Examples: Color / Material</div>
                </wa-input>
                <wa-input name="optionNames[1]" value="Size" label="Option 2 Name"
                          oninput="syncOptionHeader(2,this.value)">
                    <div slot="helper" class="help">Examples: Size / Length</div>
                </wa-input>
                <wa-input name="optionNames[2]" label="Option 3 Name" oninput="syncOptionHeader(3,this.value)">
                    <div slot="helper" class="help">Optional</div>
                </wa-input>
            </div>

            <!-- Variants -->
            <div class="section-title">Variants</div>
            <wa-card class="wa-stack" variant="neutral" style="padding:10px">
                <div class="wa-row wa-justify-between wa-items-center">
                    <div class="help">Headers reflect the option names above</div>
                    <div class="wa-row wa-gap-2">
                        <wa-button variant="primary" onclick="addVariantRow()" type="button">Add variant</wa-button>
                        <wa-button variant="neutral" onclick="clearVariants()" type="button">Clear</wa-button>
                    </div>
                </div>

                <div class="variants-scroll">
                    <table class="wa-table sticky-head zebra">
                        <thead>
                        <tr>
                            <th id="opt-h1">Color</th>
                            <th id="opt-h2">Size</th>
                            <th id="opt-h3">Option3</th>
                            <th>Variant ID</th>
                            <th>SKU</th>
                            <th style="width:120px">Price</th>
                            <th style="width:140px">Compare At Price</th>
                            <th>Available</th>
                            <th>Image URL</th>
                            <th style="width:60px">#</th>
                        </tr>
                        </thead>
                        <tbody id="variants-body">
                        <tr class="empty-row" id="variants-empty">
                            <td colspan="10">No variants yet. Click <b>Add variant</b>.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </wa-card>

            <div class="sticky-actions">
                <span id="create-spinner" class="help" hidden>Saving…</span>
                <wa-button id="btn-create" type="button" variant="primary"
                           onclick="if (validateProductForm()) { document.getElementById('create-product-form').requestSubmit(); }">
                    Create
                </wa-button>
            </div>
        </form>
    </wa-card>

    <!-- 行模板 -->
    <template id="variant-row-tpl">
        <tr>
            <td>
                <wa-input placeholder="e.g. Black" name="variants[__i__].option1"></wa-input>
            </td>
            <td>
                <wa-input placeholder="e.g. XS" name="variants[__i__].option2"></wa-input>
            </td>
            <td>
                <wa-input name="variants[__i__].option3"></wa-input>
            </td>
            <td>
                <wa-input type="number" required name="variants[__i__].variantId"></wa-input>
            </td>
            <td>
                <wa-input name="variants[__i__].sku"></wa-input>
            </td>
            <td>
                <wa-input type="number" step="0.01" min="0.01" name="variants[__i__].price"></wa-input>
            </td>
            <td>
                <wa-input type="number" step="0.01" min="0.01" name="variants[__i__].comparePrice"></wa-input>
            </td>
            <td style="text-align:center">
                <wa-switch name="variants[__i__].available"></wa-switch>
            </td>
            <td>
                <wa-input name="variants[__i__].imageUrl" placeholder="https://..."></wa-input>
            </td>
            <td>
                <wa-button size="sm" variant="danger" onclick="this.closest('tr').remove(); updateEmptyState();"
                           type="button">Del
                </wa-button>
            </td>
        </tr>
    </template>

    <script>
        var variantIndex = typeof window.variantIndex === 'number' ? window.variantIndex : 0;

        function updateEmptyState() {
            const body = document.getElementById('variants-body');
            const empty = document.getElementById('variants-empty');
            const hasData = body.querySelectorAll('tr:not(#variants-empty)').length > 0;
            if (empty) empty.style.display = hasData ? 'none' : '';
        }

        function addVariantRow(initial = {}) {
            const tpl = document.getElementById('variant-row-tpl').innerHTML.replaceAll('__i__', variantIndex++);
            const tmp = document.createElement('tbody');
            tmp.innerHTML = tpl;
            const row = tmp.firstElementChild;

            if (initial.option1) row.querySelector('[name$=".option1"] input')?.setAttribute('value', initial.option1);
            if (initial.option2) row.querySelector('[name$=".option2"] input')?.setAttribute('value', initial.option2);
            if (initial.option3) row.querySelector('[name$=".option3"] input')?.setAttribute('value', initial.option3);

            document.getElementById('variants-body').appendChild(row);
            updateEmptyState();
        }

        function clearVariants() {
            const body = document.getElementById('variants-body');
            body.querySelectorAll('tr:not(#variants-empty)').forEach(tr => tr.remove());
            variantIndex = 0;
            updateEmptyState();
        }

        function resetVariantTable() {
            clearVariants();
            addVariantRow();
        }

        function syncOptionHeader(k, val) {
            const th = document.getElementById('opt-h' + k);
            if (!th) return;
            const txt = (val && val.trim()) ? val.trim() : ('Option' + k);
            th.textContent = txt;

            if (k === 3) {
                const show = !!(val && val.trim());
                const table = th.closest('table');
                const idx = [...th.parentNode.children].indexOf(th) + 1;
                table.querySelectorAll('tr > *:nth-child(' + idx + ')').forEach(cell => {
                    cell.style.display = show ? '' : 'none';
                });
            }
        }

        function getTrimmedLower(s) {
            return (s || '').trim().toLowerCase();
        }

        function validateProductForm() {
            // 1) Option Name 不重复
            const n1 = document.querySelector('[name="optionNames[0]"] input')?.value || '';
            const n2 = document.querySelector('[name="optionNames[1]"] input')?.value || '';
            const n3 = document.querySelector('[name="optionNames[2]"] input')?.value || '';
            const names = [n1, n2, n3].map(v => v.trim()).filter(v => v.length > 0);
            const lower = names.map(v => v.toLowerCase());
            const distinct = Array.from(new Set(lower));
            if (lower.length !== distinct.length) {
                alert('Option Name 不能相同');
                return false;
            }

            // 2) 至少 1 行 variant
            const rows = document.querySelectorAll('#variants-body tr:not(#variants-empty)');
            if (rows.length === 0) {
                alert('Please add at least one variant.');
                return false;
            }

            // 3) 价格校验
            for (const tr of rows) {
                const priceEl = tr.querySelector('[name$=".price"]');
                const priceStr = (priceEl?.value ?? priceEl?.getAttribute('value') ?? '').toString().trim();
                const price = parseFloat(priceStr);
                if (!(price > 0)) {
                    alert('Price 必须大于 0');
                    (priceEl?.focus?.())?.();
                    return false;
                }

                const compEl = tr.querySelector('[name$=".comparePrice"]');
                const compStr = (compEl?.value ?? compEl?.getAttribute('value') ?? '').toString().trim();
                if (compStr) {
                    const compare = parseFloat(compStr);
                    if (!isNaN(compare) && compare < price) {
                        alert('Compare At Price 应该 ≥ Price');
                        (compEl?.focus?.())?.();
                        return false;
                    }
                }
            }

            return true;
        }
    </script>
</th:block>
</html>
