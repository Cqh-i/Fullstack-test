<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Products</title>
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/styles/webawesome.css" />
    <script type="module" src="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/webawesome.loader.js"></script>

    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; margin: 24px; }
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; }
        .btn.primary { background: #111827; color: #fff; border-color: #111827; }
        .muted { color: #6b7280; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border-bottom: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; vertical-align: top; }
        thead th { background: #f8fafc; }
        img.thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .indicator[hidden] { display: none; }

        .wa-page { padding:4px 10px; border:1px solid #d1d5db; border-radius:6px; text-decoration:none; cursor:pointer; }
        .wa-page.wa-active { background:#111827; color:#fff; border-color:#111827; }
        .wa-page.wa-disabled { opacity:.5; pointer-events:none; }
        .wa-ellipsis { padding:0 4px; color:#6b7280; }
        .pager-wrap { display:flex; justify-content:center; margin-top:8px; }
        .wa-pagination { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:12px;}
        .tags-wrap wa-badge { margin-right: 6px; margin-bottom: 4px; }
        .tag-pill { display:inline-block; padding:2px 8px; margin:2px 6px 2px 0; font-size:12px; line-height:18px; border-radius:9999px; background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0; white-space:nowrap; }
        .page-wrap { width: 80%; margin: 24px auto; }

        /* 防止 Web Components 初始化前闪现 */
        wa-dialog:not([open]) { display: none; }

        /* ===== 美化 wa-dialog（若库暴露 ::part 将生效；未暴露则优雅降级，仅使用内容区样式） ===== */
        /* 面板圆角与阴影（部分库支持 ::part(panel) 命名，若不支持会被忽略，不影响页面） */
        wa-dialog::part(panel) {
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,.22);
            border: 1px solid #e5e7eb;
        }
        /* 关闭按钮轻一点 */
        wa-dialog::part(close-button) {
            color: #64748b;
        }

        /* 自定义内容区样式（必生效，因为这是你的光 DOM） */
        .modal-success {
            padding: 6px 2px 2px;
            min-width: 360px;
            max-width: 520px;
            animation: scaleIn .18s ease-out;
        }
        .modal-success .icon-wrap {
            width: 56px; height: 56px; border-radius: 50%;
            display: grid; place-items: center;
            background: radial-gradient(120% 120% at 0% 0%, #22c55e 0%, #16a34a 60%, #0e9f6e 100%);
            box-shadow: 0 6px 16px rgba(16,185,129,.35);
            margin: 4px auto 10px;
            color: white; font-size: 28px; font-weight: 700;
        }
        .modal-success .headline {
            text-align: center;
            margin: 4px 0 6px;
            font-weight: 700; font-size: 18px; color: #0f172a;
            letter-spacing: .2px;
        }
        .modal-success .body {
            text-align: center;
            color: #334155; font-size: 14px; line-height: 1.6;
            margin: 0 2px 8px;
        }
        .modal-success .actions {
            display: flex; gap: 10px; justify-content: center;
            margin-top: 12px;
        }
        /* 移动端更友好：按钮占满一行 */
        @media (max-width: 520px) {
            .modal-success { min-width: 0; width: 86vw; }
            .modal-success .actions > * { flex: 1 1 auto; }
        }
        @keyframes scaleIn {
            from { transform: translateY(6px) scale(.98); opacity: 0; }
            to   { transform: translateY(0) scale(1);    opacity: 1; }
        }
    </style>
</head>
<body>
<div class="page-wrap">

    <h2 style="margin:0 0 8px 0">Products</h2>
    <div class="row">
        <wa-button
                variant="brand"
                hx-get="/products"
                hx-target="#products"
                hx-swap="outerHTML"
                hx-indicator="#spinner">
            Load products
        </wa-button>
        <span id="spinner" class="indicator muted" hidden>Loading…</span>
        <span class="muted">Tip: Click “Load products” to fetch from the database.</span>
    </div>

    <table>
        <thead>
        <tr>
            <th style="width:160px">Product&nbsp;ID</th>
            <th style="width:160px">Title</th>
            <th style="width:160px">Vendor</th>
            <th style="width:160px">Product Type</th>
            <th style="width:160px">Tags</th>
            <th style="width:120px">Min&nbsp;Price</th>
            <th style="width:160px">Updated</th>
            <th style="width:96px">Image</th>
            <th style="width:160px">Action</th>
        </tr>
        </thead>

        <!-- 初始不加载；提示用户点击按钮 -->
        <tbody id="products">
        <tr>
            <td colspan="9" class="muted">No data yet. Click “Load products”.</td>
        </tr>
        </tbody>
    </table>

    <!-- 分页条占位：首次为空，等片段通过 OOB 更新 -->
    <div class="pager-wrap">
        <nav id="pager" class="wa-pagination muted" aria-label="Pagination"></nav>
    </div>

    <!-- 创建表单容器（第一次加载产品后再异步载入表单） -->
    <div id="create-form" hidden>
        <div class="muted" style="margin:12px 0">Scroll to load the create form…</div>
    </div>

    <!-- 成功弹窗 -->
    <wa-dialog id="created-modal" size="sm">
        <div class="modal-success" role="status" aria-live="polite">
            <div class="icon-wrap">✓</div>
            <div class="headline">Product added</div>
            <div class="body">Product has been added successfully.</div>
            <div class="actions">
                <wa-button variant="brand" autofocus onclick="document.getElementById('created-modal').open=false">OK</wa-button>
            </div>
        </div>
    </wa-dialog>

    <!-- 新增：删除确认弹窗 -->
    <wa-dialog id="confirm-delete-modal" size="sm" aria-label="Confirm delete">
        <div class="modal-success" role="alertdialog" aria-describedby="confirm-delete-desc">
            <div class="icon-wrap">!</div>
            <div class="headline">确认删除产品</div>
            <div id="confirm-delete-desc" class="body">
                此操作将删除该产品及其所有变体，且不可撤销。<br/>
                产品ID：<strong id="del-id"></strong><br/>
                标题：<strong id="del-title"></strong>
            </div>
            <div class="actions">
                <wa-button variant="neutral" data-dialog="close">取消</wa-button>
                <wa-button id="confirm-delete-btn" variant="danger" data-dialog="close">
                    删除
                </wa-button>
            </div>
        </div>
    </wa-dialog>

    <script>
        // 当 #products 被 htmx 替换（首次加载/后续刷新）后，展示“Add product”表单
        (function () {
            if (window.__createFormLoaderInited) return;
            window.__createFormLoaderInited = true;

            let formLoaded = false;
            document.body.addEventListener('htmx:afterSwap', function (e) {
                const swapped = e.detail && e.detail.target;
                if (!swapped || swapped.id !== 'products' || formLoaded) return;

                formLoaded = true;
                const host = document.getElementById('create-form');
                host.hidden = false;
                htmx.ajax('GET', '/products/form', { target: '#create-form', swap: 'outerHTML' });
            });
        })();

        // 统一错误提示
        document.body.addEventListener('htmx:responseError', (e) => {
            alert('Request failed: ' + e.detail.xhr.status);
        });

        // ② 处理“变体展开/收起”按钮
        (function () {
            const isToggler = (el) => el instanceof Element && el.classList.contains('toggle-variants');

            // 1) 已展开时：在捕获阶段拦截，彻底阻止 htmx 发送请求
            document.addEventListener('click', function (e) {
                const path = (typeof e.composedPath === 'function') ? e.composedPath() : [];
                // 优先从 composedPath 里找（兼容 Shadow DOM），找不到再 fallback 到 closest
                let btn = path.find((n) => isToggler(n));
                if (!btn && e.target && e.target.closest) btn = e.target.closest('.toggle-variants');
                if (!btn) return;

                if (btn.dataset.opened === 'true') {
                    const row = document.getElementById('variants-' + btn.dataset.pid);
                    if (row) row.remove();
                    btn.dataset.opened = 'false';
                    btn.textContent = 'Display variants';

                    // 三连阻断，避免 htmx 仍然发送请求
                    e.preventDefault();
                    e.stopPropagation();
                    if (e.stopImmediatePropagation) e.stopImmediatePropagation();
                }
            }, true); // ← 用捕获阶段

            // 首次展开：请求成功后把按钮文案切到 “Hide variants”
            document.body.addEventListener('htmx:afterRequest', function (e) {
                const el = e.target;
                if (!isToggler(el)) return;

                const xhr = e.detail && e.detail.xhr;
                if (xhr && xhr.status >= 200 && xhr.status < 400) {
                    el.dataset.opened = 'true';
                    el.textContent = 'Hide variants';
                }
            });
        })();

        // ③ 监听创建产品提交成功并弹窗
        (function () {
            document.body.addEventListener('htmx:afterRequest', function (e) {
                const xhr = e.detail && e.detail.xhr;
                const elt = e.detail && e.detail.elt;   // 触发请求的元素（这里期望是 #create-product-form）

                if (!(xhr && elt && elt.id === 'create-product-form')) return;
                if (xhr.status < 200 || xhr.status >= 400) return;

                // 成功判定优先级：
                // A) 后端通过 HX-Trigger 或 HX-Trigger-After-Swap 显式触发 "product:created"
                const trig = (xhr.getResponseHeader('HX-Trigger') || '') + ' ' + (xhr.getResponseHeader('HX-Trigger-After-Swap') || '');
                let success = /\bproduct:created\b/i.test(trig);

                // B) 兼容：响应体包含产品表格片段标识（常见成功分支）
                if (!success && typeof xhr.responseText === 'string' && xhr.responseText.indexOf('products_tbody') >= 0) {
                    success = true;
                }

                // C) 兼容：响应体中不再包含“create-product-form”（通常说明没有返回表单错误，而是转到别的片段）
                if (!success && typeof xhr.responseText === 'string' && xhr.responseText.indexOf('create-product-form') === -1) {
                    success = true;
                }

                if (success) {
                    const dlg = document.getElementById('created-modal');
                    if (dlg) dlg.open = true;
                }
            });
        })();

        // ④ 打开“删除确认”对话框并配置删除请求（改为使用 htmx.ajax 触发 DELETE）
        (function () {
            const dlg = document.getElementById('confirm-delete-modal');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            const elId = document.getElementById('del-id');
            const elTitle = document.getElementById('del-title');

            const findDeleteBtn = (event) => {
                const path = (typeof event.composedPath === 'function') ? event.composedPath() : [];
                const fromPath = path.find((n) => n instanceof Element && n.classList && n.classList.contains('btn-delete'));
                if (fromPath) return fromPath;
                return event.target && event.target.closest ? event.target.closest('.btn-delete') : null;
            };

            // 点击列表中的“Delete”按钮 → 填充对话框文案与参数，打开弹窗
            document.body.addEventListener('click', function (e) {
                const btn = findDeleteBtn(e);
                if (!btn) return;

                const productId = btn.dataset.pid;
                const title = btn.dataset.title || '';
                const page = btn.dataset.page || '1';
                const size = btn.dataset.size || '10';
                const search = btn.dataset.search;

                if (elId) elId.textContent = productId;
                if (elTitle) elTitle.textContent = title;

                // 保存到确认按钮的 dataset，供确认时使用
                if (confirmBtn) {
                    confirmBtn.dataset.url = `/products/${productId}`;
                    confirmBtn.dataset.page = page;
                    confirmBtn.dataset.size = size;
                    if (search) confirmBtn.dataset.search = search; else delete confirmBtn.dataset.search;
                }

                if (dlg) dlg.open = true;
            });

            // 只绑定一次：点击“删除”确认后，用 htmx.ajax 发起 DELETE，并局部刷新 #products
            if (!window.__bindConfirmDeleteOnce) {
                window.__bindConfirmDeleteOnce = true;

                confirmBtn?.addEventListener('click', function () {
                    const baseUrl = confirmBtn.dataset.url;
                    if (!baseUrl) return;

                    const params = new URLSearchParams();
                    if (confirmBtn.dataset.page) params.set('page', confirmBtn.dataset.page);
                    if (confirmBtn.dataset.size) params.set('size', confirmBtn.dataset.size);
                    if (confirmBtn.dataset.search) params.set('search', confirmBtn.dataset.search);

                    const url = baseUrl + (params.toString() ? `?${params.toString()}` : '');

                    // 禁用按钮，避免重复提交；关闭弹窗由 data-dialog="close" 处理
                    confirmBtn.setAttribute('disabled', '');

                    htmx.ajax('DELETE', url, {
                        target: '#products',
                        swap: 'outerHTML',
                        indicator: '#spinner',
                        source: confirmBtn
                    });
                });

                // 请求完成或失败后恢复按钮可用
                document.body.addEventListener('htmx:afterRequest', function (e) {
                    if (e.detail && e.detail.elt === confirmBtn) {
                        confirmBtn.removeAttribute('disabled');
                    }
                });
                document.body.addEventListener('htmx:responseError', function (e) {
                    if (e.detail && e.detail.elt === confirmBtn) {
                        confirmBtn.removeAttribute('disabled');
                    }
                });
            }
        })();
    </script>
</div>
</body>
</html>
